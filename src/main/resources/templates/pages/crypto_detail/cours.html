<!DOCTYPE html>
<html lang="fr" th:replace="~{_layout :: layout(~{::title}, ~{::body})}" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Courbe de fluctuation du crypto</title>
</head>
<body>
<!-- Sidebar -->
<th:block th:replace="~{fragment/sidebar}"/>

<!-- Contenu principal -->
<div id="main" class="main-content">
    <div class="page-heading">
        <div class="page-title">
            <div class="row">
                <div class="col-12 col-md-6">
                    <h1>Courbe de fluctuation du crypto</h1>
                    <p class="text-subtitle text-muted">Visualisez les fluctuations des crypto-monnaies.</p>
                </div>
            </div>
        </div>

        <!-- Formulaire de sélection -->
        <section class="section">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Sélectionnez une crypto-monnaie</h4>
                </div>
                <div class="card-body">
                    <form method="get" th:action="@{/cours/chart/traitement}">
                        <div class="form-group">
                            <label for="crypto">Crypto-monnaie</label>
                            <select id="crypto" name="crypto" class="form-select">
                                <option value="#">Choisir</option>
                                <option th:each="c : ${cryptomonnaies}" 
                                        th:value="${c.id}" 
                                        th:text="${c.designation}"
                                        th:selected="${cryptoActuelle == c.id}">
                                </option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">
                            <i class="bi bi-search me-2"></i>Rechercher
                        </button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Graphique -->
        <section class="section">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title" th:text="'Graphique des fluctuations ' + ${cryptoActuelle}"></h4>
                </div>
                <div class="card-body">
                    <div id="cryptoChart"></div>
                </div>
            </div>
        </section>
    </div>
</div>

<script src="/assets/extensions/jquery/jquery.min.js"></script>
<script src="/assets/extensions/apexcharts/apexcharts.min.js"></script>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        const chartElement = document.querySelector("#cryptoChart");
        if (!chartElement) {
            console.error("Element #cryptoChart not found");
            return;
        }

        // Injection des données de coursCryptoos depuis le backend Thymeleaf
        const coursCryptoos = /*[[${coursCryptoos}]]*/ [];

        // Transformation des données en format lisible par ApexCharts
        const coursData = coursCryptoos.map(cours => ({
            x: new Date(cours.dateCours).getTime(),
            y: cours.coursActuel
        }));

        const options = {
            chart: {
                type: 'line',
                height: 350,
                background: 'transparent',
                toolbar: { show: true }
            },
            series: [{
                name: 'Prix en EUR',
                data: coursData
            }],
            xaxis: {
                type: 'datetime',
                labels: {
                    format: 'dd/MM/yyyy' // format de date à afficher sur l'axe X
                }
            },
            stroke: { curve: 'smooth' }
        };

        try {
            const chart = new ApexCharts(chartElement, options);
            chart.render();
        } catch (error) {
            console.error("Error rendering chart:", error);
        }
    });
</script>

</body>
</html>
