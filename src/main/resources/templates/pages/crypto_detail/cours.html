<!DOCTYPE html>
<html lang="fr" th:replace="~{_layout :: layout(~{::title}, ~{::body})}" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Courbe de fluctuation du crypto</title>
</head>
<body>
<!-- Sidebar -->
<th:block th:replace="~{fragment/sidebar}"/>

<!-- Contenu principal -->
<div id="main" class="main-content">
    <div class="page-heading">
        <div class="page-title">
            <div class="row">
                <div class="col-12 col-md-6">
                    <h1>Courbe de fluctuation du crypto</h1>
                    <p class="text-subtitle text-muted">Visualisez les fluctuations des crypto-monnaies.</p>
                </div>
            </div>
        </div>

        <!-- Formulaire de sélection -->
        <section class="section">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">Sélectionnez une crypto-monnaie</h4>
                </div>
                <div class="card-body">
                    <form method="get" th:action="@{/cours/chart/traitement}">
                        <div class="form-group">
                            <label for="crypto">Crypto-monnaie</label>
                            <select id="crypto" name="crypto" class="form-select">
                                <option value="#">Choisir</option>
                                <option th:each="c : ${cryptomonnaies}" 
                                        th:value="${c.id}" 
                                        th:text="${c.designation}"
                                        th:selected="${cryptoActuelle == c.id}">
                                </option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">
                            <i class="bi bi-search me-2"></i>Rechercher
                        </button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Graphique -->
        <section class="section">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title" th:text="'Graphique des fluctuations ' + ${cryptoActuelle}"></h4>
                </div>
                <div class="card-body">
                    <div id="cryptoChart"></div>
                </div>
            </div>
        </section>
    </div>
</div>

<script src="/assets/extensions/jquery/jquery.min.js"></script>
<script src="/assets/extensions/apexcharts/apexcharts.min.js"></script>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        const chartElement = document.querySelector("#cryptoChart");
        if (!chartElement) {
            console.error("Element #cryptoChart not found");
            return;
        }

        // Injection des données de coursCryptoos depuis le backend Thymeleaf
        const coursCryptoos = /*[[${coursCryptoos}]]*/ [];

        // Transformation des données en format lisible par ApexCharts
        const coursData = coursCryptoos.map(cours => ({
            x: new Date(cours.dateCours).getTime(),  // Convertit la date en timestamp
            y: cours.coursActuel
        }));

        const options = {
            chart: {
                type: 'line',
                height: 350,
                background: 'transparent',
                toolbar: { show: true },
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 800,
                    animateGradually: { enabled: true, delay: 150 },
                    dynamicAnimation: { enabled: true, speed: 350 }
                }
            },
            series: [{
                name: 'Prix en EUR',
                data: coursData
            }],
            xaxis: {
                type: 'datetime',
                labels: {
                    format: 'HH:mm:ss',  // Affichage de l'heure et des minutes
                    rotate: -45           // Angle des labels pour mieux les espacer
                },
                title: {
                    text: 'Temps'
                },
                min: new Date().getTime() - 60 * 1000 * 60,  // Afficher les dernières 60 minutes seulement
                max: new Date().getTime(),                    // Limiter au temps actuel
                tickAmount: 10,                               // Limite le nombre de ticks sur l'axe X
                axisBorder: {
                    show: true
                },
                axisTicks: {
                    show: true
                }
            },
            stroke: { curve: 'smooth' },
            tooltip: {
                x: {
                    format: 'dd/MM/yyyy HH:mm:ss'  // Format du tooltip pour afficher l'heure complète
                }
            }
        };

        try {
            const chart = new ApexCharts(chartElement, options);
            chart.render();

            // Rafraîchissement du graphique toutes les 10 secondes
            setInterval(function() {
                // Récupérer de nouvelles données depuis le backend et les ajouter au graphique
                // Cela dépend de la manière dont tu récupères tes données dynamiquement via Ajax ou un autre mécanisme

                // Exemple d'ajout de nouvelles données
                const newCoursCryptoos = /*[[${coursCryptoos}]]*/ [];  // Récupère les nouvelles données mises à jour
                const newCoursData = newCoursCryptoos.map(cours => ({
                    x: new Date(cours.dateCours).getTime(),
                    y: cours.coursActuel
                }));

                // Mise à jour des séries dans le graphique
                chart.updateSeries([{
                    name: 'Prix en EUR',
                    data: newCoursData
                }]);
            }, 10000);  // Met à jour toutes les 10 secondes
        } catch (error) {
            console.error("Error rendering chart:", error);
        }
    });
</script>

</body>
</html>
